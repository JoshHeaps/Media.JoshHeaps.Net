@page "{handler?}"
@model Media.JoshHeaps.Net.Pages.IndexModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/Home/page.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/gallery.css" asp-append-version="true" />
}

<div class="dashboard-container">
    <div class="welcome-section">
        <h1>Welcome back, @Model.Dashboard?.Username!</h1>
        <div class="quick-actions">
            @if (Model.Dashboard?.EmailVerified == false)
            {
                <a href="/ResendVerification?email=@Uri.EscapeDataString(Model.Dashboard.Email)" class="btn btn-primary">
                    Verify Email
                </a>
            }
            <a href="/Logout" class="btn btn-danger">Logout</a>
        </div>
    </div>

    <div class="card" id="upload-form-card" style="display:none;">
        <div class="upload-form-header">
            <h2>Upload Image</h2>
            <button type="button" class="close-upload-form" id="close-upload-btn">&times;</button>
        </div>
        @if (!string.IsNullOrEmpty(Model.UploadMessage))
        {
            <div class="alert @(Model.UploadSuccess ? "alert-success" : "alert-error")">
                @Model.UploadMessage
            </div>
        }
        <form method="post" enctype="multipart/form-data" id="upload-form">
            @Html.AntiForgeryToken()
            <div class="form-group">
                <label for="UploadedFile">Select Image(s)</label>
                <input type="file" id="UploadedFile" name="UploadedFile" accept="image/*" multiple required />
            </div>
            <div class="form-group">
                <label for="Description">Description (optional)</label>
                <textarea id="Description" name="Description" rows="3" placeholder="Add a description for all images..."></textarea>
            </div>
            <div id="upload-progress" style="display:none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Uploading...</div>
            </div>
            <button type="submit" class="btn btn-primary" id="upload-btn">Upload</button>
        </form>
    </div>

    <div class="card">
        <h2>My Images (@Model.MediaItems.Count)</h2>
        <div id="gallery" class="gallery-grid">
            @foreach (var media in Model.MediaItems)
            {
                <div class="gallery-item" data-media-id="@media.Id">
                    <img src="/api/media/image/@media.Id" alt="@media.FileName" loading="lazy" />
                    @if (!string.IsNullOrEmpty(media.Description))
                    {
                        <div class="gallery-item-description">@media.Description</div>
                    }
                    <div class="gallery-item-info">
                        <span class="gallery-item-date">@media.CreatedAt.ToString("MMM d, yyyy")</span>
                        <form method="post" style="display:inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="MediaId" value="@media.Id" />
                            <button type="submit" class="btn-delete" onclick="return confirm('Are you sure you want to delete this image?');" asp-page-handler="Delete">Delete</button>
                        </form>
                    </div>
                </div>
            }
        </div>
        <div id="loading" style="display:none; text-align:center; padding:20px;">
            Loading more images...
        </div>
    </div>
</div>

<!-- Floating Add Files Button -->
<button type="button" class="floating-add-btn" id="add-files-btn" title="Add Files">
    <span class="btn-icon">+</span>
</button>

@section Scripts {
    <script src="~/js/gallery.js" asp-append-version="true"></script>
    <script src="~/js/upload.js" asp-append-version="true"></script>
}